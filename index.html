<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Visitor Parking</title>

<style>
  * { box-sizing: border-box; } /* FIX overflow */

  body{
    font-family: Arial, sans-serif;
    background:#e9f5e9;
    margin:0;
    padding:14px;
    text-transform: uppercase;
  }

  h2{
    text-align:center;
    color:#176B39;
    margin:10px 0 10px 0;
    letter-spacing:1px;
    font-size:34px;
  }

  .datetime-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    max-width:320px;
    margin:0 auto 16px auto;
    padding:8px 16px;
    border-radius:18px;
    background:linear-gradient(90deg,#41e671 0%, #176B39 100%);
    color:#fff;
    font-size:13px;
    font-weight:bold;
    box-shadow:0 4px 10px rgba(0,0,0,.15);
  }

  .card{
    background:#fff;
    border-radius:18px;
    padding:16px;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
    max-width:520px;
    margin:0 auto;
  }

  label{
    font-weight:800;
    font-size:14px;
    display:block;
    margin-top:12px;
    color:#222;
  }

  select, input{
    width:100%;
    padding:14px;
    font-size:18px;
    border-radius:12px;
    border:2px solid #176B39;
    margin-top:8px;
    background:#ffffff;
    outline:none;
  }

  select:focus, input:focus{
    background:#fff;
  }

  /* LOT nav */
  .lot-nav{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:8px;
  }
  .navbtn{
    width:72px;
    padding:14px 0;
    border-radius:12px;
    border:none;
    background:#176B39;
    color:#fff;
    font-size:18px;
    font-weight:900;
  }
  .navbtn:active{ transform:scale(.98); }

  .lot-display{
    flex:1;
    text-align:center;
    padding:14px 0;
    border-radius:12px;
    border:2px solid #176B39;
    font-size:20px;
    font-weight:900;
    background:#f3f3f3;
    color:#176B39;
  }

  /* REG + camera button */
  .reg-row{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:8px;
  }
  .reg-row input{ flex:1; margin-top:0; }
  .camBtn{
    width:64px;
    height:56px;
    border:none;
    border-radius:14px;
    background:#176B39;
    color:#fff;
    font-size:22px;
    font-weight:900;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
  }
  .camBtn:active{ transform:scale(.98); }

  .hint{
    margin-top:10px;
    text-align:center;
    font-size:12px;
    color:#666;
    font-weight:800;
  }

  button.submit{
    width:100%;
    margin-top:16px;
    padding:16px;
    font-size:18px;
    border-radius:14px;
    border:none;
    background:linear-gradient(90deg,#41e671,#176B39);
    color:#fff;
    font-weight:900;
    letter-spacing:1px;
  }
  button.submit:active{ transform:scale(.99); }

  .status{
    text-align:center;
    margin-top:12px;
    font-size:14px;
    font-weight:900;
    line-height:1.4;
  }

  .footer{
    text-align:center;
    font-size:11px;
    color:#666;
    margin-top:10px;
  }
</style>
</head>

<body>

<div class="datetime-bar">
  <span id="currentDate">--/--/----</span>
  <span id="currentTime">--:--:--</span>
</div>

<h2>VISITOR PARKING</h2>

<div class="card">

  <label>ROUND TIME</label>
  <select id="round">
    <option value="">- PLEASE SELECT -</option>
    <option>08:00</option>
    <option>11:00</option>
    <option>14:00</option>
    <option>17:00</option>
    <option>20:00</option>
    <option>23:00</option>
    <option>02:00</option>
    <option>05:00</option>
  </select>

  <label>LOT</label>
  <div class="lot-nav">
    <button type="button" class="navbtn" onclick="prevLot()">‚óÄ</button>
    <div class="lot-display" id="lotDisplay">GV01</div>
    <button type="button" class="navbtn" onclick="nextLot()">‚ñ∂</button>
  </div>

  <label>REG NUM</label>
  <div class="reg-row">
    <input id="regInput" placeholder="ABC1234" autocomplete="off" inputmode="text" />
    <button type="button" class="camBtn" onclick="openCam()">üì∑</button>
  </div>

  <input id="camInput" type="file" accept="image/*" capture="environment" style="display:none" />

  <div class="hint" id="hintText">LOT GV01 / 33 (Swipe kiri/kanan pun boleh)</div>

  <button class="submit" type="button" onclick="submitAll()">SUBMIT ALL</button>

  <div class="status" id="status"></div>
</div>

<div class="footer">Powered by MRED TECH</div>

<!-- Tesseract.js (Plate OCR) -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/* =========================
   SETTINGS
========================= */
const WORKER_URL = "https://PASTE-YOUR-WORKER-URL-HERE"; // <-- WAJIB tukar
const TOTAL_LOTS = 33;

/* =========================
   DATETIME BAR (display only)
========================= */
function updateDateTime(){
  const now = new Date();
  document.getElementById("currentDate").innerText =
    now.toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});
  document.getElementById("currentTime").innerText =
    now.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateDateTime, 1000);
updateDateTime();

/* =========================
   BEEP (WebAudio) + VIBRATE
========================= */
let audioCtx = null;

function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
}

function beep() {
  try {
    ensureAudio();
    if (!audioCtx) return;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = "square";
    o.frequency.value = 880;
    g.gain.value = 0.08;

    o.connect(g);
    g.connect(audioCtx.destination);

    o.start();
    o.stop(audioCtx.currentTime + 0.06);
  } catch (e) {}
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate(50);
}

// unlock audio on first touch/click
document.addEventListener("click", ensureAudio, { once:true });
document.addEventListener("touchstart", ensureAudio, { once:true, passive:true });

/* =========================
   SEQUENTIAL LOT INPUT
========================= */
let lotIndex = 1; // 1..33
const plates = {};
for (let i = 1; i <= TOTAL_LOTS; i++){
  plates[`GV${String(i).padStart(2,"0")}`] = "";
}

const regInput   = document.getElementById("regInput");
const lotDisplay = document.getElementById("lotDisplay");
const hintText   = document.getElementById("hintText");
const statusBox  = document.getElementById("status");

function lotId(i){ return `GV${String(i).padStart(2,"0")}`; }
function normalizePlate(v){ return (v || "").toUpperCase().replace(/[^A-Z0-9]/g,""); }

regInput.addEventListener("input", () => {
  regInput.value = normalizePlate(regInput.value);
  plates[lotId(lotIndex)] = regInput.value.trim();
});

function renderLot(){
  const lot = lotId(lotIndex);
  lotDisplay.textContent = lot;
  regInput.value = plates[lot] || "";
  hintText.textContent = `LOT ${lot} / ${TOTAL_LOTS} (Swipe kiri/kanan pun boleh)`;
  regInput.focus();
}

function nextLot(){
  plates[lotId(lotIndex)] = regInput.value.trim();
  if (lotIndex < TOTAL_LOTS) lotIndex++;
  renderLot();
  beep(); vibrate();
}

function prevLot(){
  plates[lotId(lotIndex)] = regInput.value.trim();
  if (lotIndex > 1) lotIndex--;
  renderLot();
  beep(); vibrate();
}

/* Swipe support */
let touchStartX = 0;
document.addEventListener("touchstart", (e)=>{ touchStartX = e.changedTouches[0].screenX; }, {passive:true});
document.addEventListener("touchend", (e)=>{
  const dx = e.changedTouches[0].screenX - touchStartX;
  if (Math.abs(dx) > 60) (dx < 0) ? nextLot() : prevLot();
}, {passive:true});

/* =========================
   CAMERA + TESSERACT (manual)
========================= */
const camInput = document.getElementById("camInput");

function openCam(){
  try{ ensureAudio(); }catch(e){}
  camInput.value = "";
  camInput.click();
}

camInput.addEventListener("change", async () => {
  const file = camInput.files && camInput.files[0];
  if (!file) return;

  statusBox.style.color = "#333";
  statusBox.innerHTML = "‚è≥ SCANNING PLATE...";

  try{
    const imgURL = URL.createObjectURL(file);
    const img = await loadImage(imgURL);

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    // scale for speed
    const maxW = 1280;
    const scale = Math.min(1, maxW / img.width);
    canvas.width = Math.floor(img.width * scale);
    canvas.height = Math.floor(img.height * scale);

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // preprocess: grayscale + contrast boost
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const d = imageData.data;

    const contrast = 1.35;
    const intercept = 128 * (1 - contrast);

    for (let i=0; i<d.length; i+=4){
      const r = d[i], g = d[i+1], b = d[i+2];
      let v = 0.299*r + 0.587*g + 0.114*b;
      v = v*contrast + intercept;
      v = Math.max(0, Math.min(255, v));
      d[i] = d[i+1] = d[i+2] = v;
    }
    ctx.putImageData(imageData, 0, 0);

    const result = await Tesseract.recognize(canvas, "eng", {
      logger: (m) => {
        if (m.status === "recognizing text") {
          const pct = Math.round((m.progress || 0) * 100);
          statusBox.innerHTML = `‚è≥ SCANNING... ${pct}%`;
        }
      }
    });

    const raw = (result?.data?.text || "");
    const plate = cleanPlate(raw);

    if (!plate) {
      statusBox.style.color = "red";
      statusBox.innerHTML = "‚ùå FAIL READ. TRY AGAIN (TAKE CLOSER / STRAIGHT).";
      return;
    }

    regInput.value = plate;
    plates[lotId(lotIndex)] = plate;

    statusBox.style.color = "green";
    statusBox.innerHTML = `‚úÖ DETECTED: ${plate}`;
    beep(); vibrate();
    regInput.focus();

  }catch(err){
    statusBox.style.color = "red";
    statusBox.innerHTML = "‚ùå OCR ERROR. TRY AGAIN.";
  }
});

function cleanPlate(text){
  return (text || "")
    .toUpperCase()
    .replace(/[^A-Z0-9]/g,"")
    .trim();
}

function loadImage(url){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

/* =========================
   SUBMIT ONCE (BATCH)
========================= */
async function submitAll(){
  const round = document.getElementById("round").value;
  if (!round){
    statusBox.innerHTML = "‚ö†Ô∏è PLEASE SELECT ROUND TIME";
    statusBox.style.color = "red";
    return;
  }

  plates[lotId(lotIndex)] = regInput.value.trim();

  const items = [];
  for (let i = 1; i <= TOTAL_LOTS; i++){
    const lot = lotId(i);
    const plate = (plates[lot] || "").trim();
    if (plate) items.push({ round, lot, plate });
  }

  if (items.length === 0){
    statusBox.innerHTML = "‚ö†Ô∏è NO REG NUM FILLED";
    statusBox.style.color = "red";
    return;
  }

  statusBox.innerHTML = `‚è≥ SUBMITTING ${items.length} LOTS...`;
  statusBox.style.color = "#333";

  try{
    const res = await fetch(WORKER_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ batch:true, items })
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.message || "Submit failed");

    statusBox.innerHTML =
      `‚úÖ SAVED ${data.saved} LOTS<br>` +
      `FREE: ${data.summary?.free ?? 0} | CHARGED: ${data.summary?.charged ?? 0}`;
    statusBox.style.color = "green";
    beep(); vibrate();

  }catch(e){
    statusBox.innerHTML = "‚ùå ERROR SUBMITTING DATA";
    statusBox.style.color = "red";
  }
}

renderLot();
</script>

</body>
  </html>
